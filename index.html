<head>
  <script>
    function log(...args) {
      const text = args.map(arg => JSON.stringify(arg)).join(' ')
      document.body.append(Object.assign(document.createElement('pre'), {
        textContent: text
      }))
    }
  </script>
  <script type="module">
    await navigator.serviceWorker.register("sw.js", {type: 'module'});
    if (!navigator.serviceWorker.controller) {
      await new Promise(resolve => navigator.serviceWorker.addEventListener('controllerchange', resolve))
    }
    log(navigator.serviceWorker.controller.scriptURL + ' ' + navigator.serviceWorker.controller.state);

    navigator.serviceWorker.addEventListener('message', e => {
      log('m1', e.data)
      e.stopImmediatePropagation()
    })
    navigator.serviceWorker.addEventListener('message', e => {
      log('m2')
    })
    navigator.serviceWorker.onmessage = e=>log('on m')

    fetch('fake')
  </script>
</head>
<body>
</body>
