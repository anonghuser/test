<head>
  <script>
    (async()=>{
      navigator.serviceWorker.addEventListener('controllerchange', event => {
        console.log('controllerchange', navigator.serviceWorker.controller);
      });
      async function wait(sw) {
        if (!sw || sw.state=='activated') return;
        await new Promise((resolve, reject) => {
          sw.addEventListener('statechange', event => {
            console.log(sw.state);
            if (sw.state == 'activated') resolve();
          })
          sw.addEventListener('error', event => {
            console.log('sw error', event);
            reject('sw error');
          })
        })
      }
      const swreg = await navigator.serviceWorker.register("sw.js?a=b#c", {type: 'module', scope:'./#boo'});
      console.log(swreg.installing, swreg.waiting);
      console.log('1', navigator.serviceWorker.controller);
      await wait(swreg.installing || swreg.waiting);
      console.log('2', navigator.serviceWorker.controller);
      console.log(await fetch('fs/').then(r=>r.json()))
    })()
  </script>
</head>
<body>
  test
  <iframe style="width:90%;height:500px" src="https://flems.io/#0=N4IgZglgNgpgziAXAbVAOwIYFsZJAOgAsAXLKEAGhAGMB7NYmBvAHgjACdsYACOD6gF4AOiBLEADnEQB6GRjT0A5oQCucGB3xKIxNQCN8EWjMZxiMiR1oAPAJ6iAfCxnsuOR5RAbY1YsbQERBAABkQANgBmEABfCnRuPHwAKwQqOgYmYjwwGGJqQgAKAHJxKVl5RTQVdU1tXQMjEzMLK1s7YoBKfD0mQo5BRwy4Wlh8KFolfvxzDGJ1Ts6vHxg-AKDQxAB2Ldj4kEwcJOo4NJp6RmZg2IBdGKA"></iframe>
</body>
