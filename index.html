<head>
  <script>
    function log(...args) {
      const text = args.map(arg => {
        if (typeof arg == 'string') return arg
        if (typeof arg == 'function') return String(arg)
        try {
          return JSON.stringify(arg)
        }
        catch(e) {
          return `<JSON error:${e}>`
        }
      }).join(' ')
      document.body.append(Object.assign(document.createElement('pre'), {
        textContent: text
      }))
    }
  </script>
  <script type="module">
    await navigator.serviceWorker.register("sw.js", {type: 'module'});
    if (!navigator.serviceWorker.controller) {
      await new Promise(resolve => navigator.serviceWorker.addEventListener('controllerchange', resolve))
    }
    log(navigator.serviceWorker.controller.scriptURL + ' ' + navigator.serviceWorker.controller.state);

    navigator.serviceWorker.addEventListener('message', e => {
      log('message', e.data)
      e.stopImmediatePropagation()
    })

    const response = await fetch('fake')
    for await(const chunk of response.body.getReader()) {
      log(chunk)
    }
  </script>
</head>
<body>
</body>
